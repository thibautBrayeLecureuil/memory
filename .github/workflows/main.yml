on:
  push:
    branches:
      - develop

jobs : 
  test-memory-2026:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check des fichiers JPG
        run: |
          for file in $(find . -type f -name "*.jpg"); do
            echo "Check $file"
            file "$file"
            type=$(file "$file")
            if ! echo "$type" | grep -q "JPEG image data"; then
              echo "$file est corrompu"
              cp ./default.jpg "$file"
            fi
          done

  build-memory-2026:
    runs-on: [self-hosted, linux]
    needs: test-memory-2026
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ${{ github.actor }}/memory-2026 .

  push-memory-2026:
    runs-on: [self-hosted, linux]
    needs: build-memory-2026
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Push
        run: |
          docker push ${{ github.actor }}/memory-2026
